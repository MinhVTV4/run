<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marathon Tracker</title>
    
    <!-- Tích hợp Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tích hợp LeafletJS cho bản đồ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- CSS tùy chỉnh bổ sung -->
    <style>
        :root { --app-height: 100%; }
        html, body {
            padding: 0;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            height: var(--app-height);
        }
        #map {
            height: 100%;
            width: 100%;
            background-color: #f3f4f6;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            margin: 10px;
            font-size: 14px;
            font-weight: bold;
        }
        /* Nút điều khiển bản đồ */
        .map-control-button {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 9999px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
        }
        .map-control-button:hover {
            background-color: #f3f4f6;
        }
        .map-control-button.active {
            background-color: #14b8a6; /* Màu teal khi active */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 font-sans">

    <!-- MÀN HÌNH ĐĂNG NHẬP -->
    <div id="loginScreen" class="flex flex-col items-center justify-center h-full p-4 text-center">
        <h1 class="text-3xl font-bold text-teal-600 mb-4">Marathon Tracker</h1>
        <p class="text-gray-600 mb-8">Đăng nhập để tham gia và chia sẻ vị trí của bạn</p>
        <button id="loginButton" class="bg-white px-4 py-2 rounded-full shadow-md font-semibold text-gray-700 flex items-center gap-3 hover:bg-gray-200">
            <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.902,35.61,44,29.593,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
            Đăng nhập với Google
        </button>
    </div>

    <!-- GIAO DIỆN CHÍNH CỦA ỨNG DỤNG -->
    <div id="appContainer" class="hidden h-full flex flex-col">
        <header class="bg-white shadow-md py-2 px-4 flex-shrink-0 flex justify-between items-center">
            <div class="flex items-center gap-2 overflow-hidden">
                <img id="userPhoto" class="w-8 h-8 rounded-full" src="" alt="User photo">
                <span id="userName" class="text-sm font-semibold text-slate-700 truncate"></span>
            </div>
            <button id="logoutButton" class="text-sm text-gray-600 hover:text-red-500 font-semibold flex-shrink-0">Đăng xuất</button>
        </header>

        <main id="map" class="flex-grow relative">
            <!-- CÁC NÚT ĐIỀU KHIỂN BẢN ĐỒ -->
            <div class="absolute top-3 right-3 z-[1000] flex flex-col gap-2">
                <button id="recenterButton" title="Định vị lại" class="map-control-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v8m-4-4h8" /></svg></button>
                <button id="fitToAllButton" title="Xem toàn cảnh" class="map-control-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4h4m12 4V4h-4M4 16v4h4m12-4v4h-4" /></svg></button>
                <button id="wakeLockButton" title="Giữ màn hình sáng" class="map-control-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg></button>
            </div>
        </main>
        
        <footer class="bg-white/80 backdrop-blur-sm p-3 text-center">
             <button id="goLiveButton" class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-teal-600 transition-all">
                Bắt đầu chia sẻ vị trí
            </button>
            <div id="statusMessage" class="hidden mt-2 text-sm text-gray-600">
                Đang chia sẻ vị trí...
            </div>
        </footer>
    </div>
    
    <script type="module">
        // --- PHẦN -1: TÍCH HỢP FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDn-3B1ZNCq9E9XuNoHHHiyIo_Pegy8Ogk",
            authDomain: "ailocal-7501e.firebaseapp.com",
            databaseURL: "https://ailocal-7501e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ailocal-7501e",
            storageBucket: "ailocal-7501e.appspot.com",
            messagingSenderId: "21856417488",
            appId: "1:21856417488:web:c3542543f12cab547b90d5"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- PHẦN 0: CÀI ĐẶT CHUNG ---
        const EVENT_ID = "marathon_2025"; // Mã định danh cho sự kiện
        const setAppHeight = () => { document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`); };
        window.addEventListener('resize', setAppHeight);
        setAppHeight();
        
        // --- PHẦN 1: THAM CHIẾU HTML ---
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const userPhoto = document.getElementById('userPhoto');
        const userName = document.getElementById('userName');
        const goLiveButton = document.getElementById('goLiveButton');
        const statusMessage = document.getElementById('statusMessage');
        const recenterButton = document.getElementById('recenterButton');
        const fitToAllButton = document.getElementById('fitToAllButton');
        const wakeLockButton = document.getElementById('wakeLockButton');

        // --- PHẦN 2: BIẾN TRẠNG THÁI & LOGIC ---
        let currentUser = null; 
        let map;
        let isLive = false;
        let watchId = null;
        let userMarkers = {};
        let myLocation = null;
        let wakeLock = null;

        // --- PHẦN 3: XỬ LÝ AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                userName.textContent = user.displayName;
                userPhoto.src = user.photoURL;
                if (!map) initMap(); 
                listenToLiveLocations();
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
                if (isLive) handleGoLive();
            }
        });

        // --- PHẦN 4: KHỞI TẠO MAP ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([21.0285, 105.8542], 13);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20
            }).addTo(map);
        }

        // --- PHẦN 5: LOGIC CHIA SẺ VỊ TRÍ ---
        function handleGoLive() {
            isLive = !isLive;
            if (isLive) {
                goLiveButton.textContent = "Dừng chia sẻ";
                goLiveButton.classList.replace('bg-teal-500', 'bg-red-500');
                goLiveButton.classList.replace('hover:bg-teal-600', 'hover:bg-red-600');
                statusMessage.classList.remove('hidden');
                const geoOptions = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                watchId = navigator.geolocation.watchPosition(updateMyLocation, handleGeoError, geoOptions);
            } else {
                goLiveButton.textContent = "Bắt đầu chia sẻ vị trí";
                goLiveButton.classList.replace('bg-red-500', 'bg-teal-500');
                goLiveButton.classList.replace('hover:bg-red-600', 'hover:bg-teal-600');
                statusMessage.classList.add('hidden');
                if (watchId) navigator.geolocation.clearWatch(watchId);
                removeMyLocationFromDB();
            }
        }
        
        function updateMyLocation(position) {
            if (!currentUser) return;
            const { latitude, longitude } = position.coords;
            myLocation = [latitude, longitude]; // Lưu vị trí của bản thân
            const myLocationRef = ref(db, `live_locations/${EVENT_ID}/${currentUser.uid}`);
            set(myLocationRef, {
                lat: latitude, lng: longitude, name: currentUser.displayName,
                photo: currentUser.photoURL, timestamp: serverTimestamp()
            });
            onDisconnect(myLocationRef).remove();
        }

        function removeMyLocationFromDB() {
             if (!currentUser) return;
             const myLocationRef = ref(db, `live_locations/${EVENT_ID}/${currentUser.uid}`);
             set(myLocationRef, null);
             myLocation = null;
        }

        function listenToLiveLocations() {
            const eventRef = ref(db, `live_locations/${EVENT_ID}`);
            onValue(eventRef, (snapshot) => {
                const locations = snapshot.val();
                if (!locations) {
                    Object.values(userMarkers).forEach(marker => marker.remove());
                    userMarkers = {};
                    return;
                }
                
                Object.keys(locations).forEach(userId => {
                    const userData = locations[userId];
                    const userLatLng = [userData.lat, userData.lng];
                    if (userMarkers[userId]) {
                        userMarkers[userId].setLatLng(userLatLng);
                    } else {
                        const icon = L.icon({
                            iconUrl: userData.photo, iconSize: [40, 40],
                            className: 'rounded-full border-2 border-white shadow-md'
                        });
                        const newMarker = L.marker(userLatLng, { icon: icon }).addTo(map);
                        newMarker.bindPopup(userData.name);
                        userMarkers[userId] = newMarker;
                    }
                });

                Object.keys(userMarkers).forEach(userId => {
                    if (!locations[userId]) {
                        userMarkers[userId].remove();
                        delete userMarkers[userId];
                    }
                });
            });
        }
        
        function handleGeoError(error) {
            console.error(error);
            alert(`Lỗi vị trí: ${error.message}`);
            if (isLive) handleGoLive();
        }

        // --- PHẦN 6: CÁC HÀM ĐIỀU KHIỂN MỚI ---
        function handleRecenter() {
            if (myLocation && map) {
                map.flyTo(myLocation, 16);
            } else {
                alert("Chưa có vị trí của bạn để định vị.");
            }
        }

        function handleFitToAll() {
            const markerGroup = Object.values(userMarkers);
            if (markerGroup.length > 0 && map) {
                const featureGroup = L.featureGroup(markerGroup);
                map.flyToBounds(featureGroup.getBounds().pad(0.2));
            } else {
                alert("Không có ai khác đang chia sẻ vị trí.");
            }
        }

        async function handleWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    if (wakeLock) { // Nếu đang bật, thì tắt đi
                        await wakeLock.release();
                        wakeLock = null;
                        wakeLockButton.classList.remove('active');
                    } else { // Nếu đang tắt, thì bật lên
                        wakeLock = await navigator.wakeLock.request('screen');
                        wakeLockButton.classList.add('active');
                        wakeLock.addEventListener('release', () => {
                            wakeLock = null;
                            wakeLockButton.classList.remove('active');
                        });
                    }
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                    alert('Không thể kích hoạt chức năng giữ màn hình sáng.');
                }
            } else {
                alert('Trình duyệt của bạn không hỗ trợ chức năng này.');
            }
        }

        // --- PHẦN 7: GẮN SỰ KIỆN ---
        const handleSignIn = () => { signInWithPopup(auth, new GoogleAuthProvider()).catch(e => console.error(e)); };
        const handleSignOut = () => { removeMyLocationFromDB(); signOut(auth).catch(e => console.error(e)); };

        loginButton.addEventListener('click', handleSignIn);
        logoutButton.addEventListener('click', handleSignOut);
        goLiveButton.addEventListener('click', handleGoLive);
        recenterButton.addEventListener('click', handleRecenter);
        fitToAllButton.addEventListener('click', handleFitToAll);
        wakeLockButton.addEventListener('click', handleWakeLock);

        // Ẩn nút wake lock nếu trình duyệt không hỗ trợ
        if (!('wakeLock' in navigator)) {
            wakeLockButton.style.display = 'none';
        }

    </script>
</body>
</html>
