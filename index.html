<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marathon Tracker</title>
    
    <!-- Tích hợp Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tích hợp LeafletJS cho bản đồ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
    
    <!-- CSS tùy chỉnh -->
    <style>
        :root { --app-height: 100%; }
        html, body {
            padding: 0; margin: 0; overflow: hidden;
            height: 100vh; height: var(--app-height);
        }
        #map { height: 100%; width: 100%; background-color: #f3f4f6; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 10px !important; font-size: 14px; font-weight: bold; line-height: 1.4; }
        .map-control-button {
            width: 40px; height: 40px; background-color: white; border-radius: 9999px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            display: flex; align-items: center; justify-content: center; transition: all 0.2s ease-in-out;
        }
        .map-control-button:hover { background-color: #f3f4f6; }
        .map-control-button.active { background-color: #14b8a6; color: white; }
        .custom-marker-icon img { width: 100%; height: 100%; border-radius: 9999px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .modal-hidden { display: none; }
        .backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 font-sans">

    <!-- GIAO DIỆN CHÍNH CỦA ỨNG DỤNG -->
    <div id="appContainer" class="h-full flex flex-col">
        <!-- Màn hình chào mừng (Mặc định) -->
        <div id="welcomeScreen" class="flex flex-col items-center justify-center h-full p-4 text-center">
            <h1 class="text-4xl font-bold text-teal-600 mb-4">Marathon Tracker</h1>
            <p class="text-gray-600 mb-8 max-w-md">Tạo phòng theo dõi riêng cho sự kiện, đội nhóm của bạn và mời mọi người tham gia chỉ bằng một đường link.</p>
            <div class="w-full max-w-sm space-y-4">
                <button id="createRoomButton" class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-teal-600 transition-all text-lg">
                    Tạo phòng mới
                </button>
                 <p class="text-sm text-gray-500">Hoặc truy cập link mời để tham gia</p>
            </div>
        </div>
        
        <!-- Màn hình bản đồ (Ẩn ban đầu) -->
        <div id="mapScreen" class="hidden h-full flex flex-col">
            <header class="bg-white shadow-md py-2 px-4 flex-shrink-0 flex justify-between items-center">
                <div class="flex items-center gap-2 overflow-hidden">
                    <img id="userPhoto" class="w-8 h-8 rounded-full" src="" alt="User photo">
                    <span id="userName" class="text-sm font-semibold text-slate-700 truncate"></span>
                </div>
                <div id="header-controls" class="flex items-center gap-4">
                     <button id="inviteButton" title="Mời bạn bè" class="map-control-button !w-auto !h-8 px-3"><span class="text-sm font-semibold">Mời</span></button>
                     <button id="memberListButton" title="Danh sách thành viên" class="map-control-button !w-8 !h-8"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg></button>
                     <button id="logoutButton" class="text-sm text-gray-600 hover:text-red-500 font-semibold flex-shrink-0">Thoát</button>
                </div>
            </header>

            <main id="map" class="flex-grow relative">
                <div id="main-map-controls" class="absolute top-3 right-3 z-[1000] flex flex-col gap-2">
                    <button id="recenterButton" title="Định vị lại" class="map-control-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v8m-4-4h8" /></svg></button>
                    <button id="fitToAllButton" title="Xem toàn cảnh" class="map-control-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4h4m12 4V4h-4M4 16v4h4m12-4v4h-4" /></svg></button>
                    <button id="wakeLockButton" title="Giữ màn hình sáng" class="map-control-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg></button>
                </div>
            </main>
            
            <footer class="bg-white/80 backdrop-blur-sm p-3 text-center">
                 <div id="controlsContainer" class="flex gap-2 items-center">
                    <button id="goLiveButton" class="flex-grow bg-teal-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-teal-600 transition-all">
                        Bắt đầu chia sẻ vị trí
                    </button>
                    <select id="statusSelector" class="hidden bg-gray-200 border border-gray-300 text-gray-900 font-semibold text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-3">
                      <option value="" disabled selected>Chọn trạng thái</option>
                      <option>Đang di chuyển</option>
                      <option>Dừng nghỉ</option>
                      <option>Gặp sự cố</option>
                      <option>Đến nơi</option>
                    </select>
                </div>
            </footer>
        </div>
    </div>

    <!-- CÁC MODAL & BOTTOM SHEET -->
    <div id="loginModal" class="modal-hidden fixed inset-0 z-[5000] flex items-center justify-center p-4">
        <div class="backdrop absolute inset-0 bg-black bg-opacity-60"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-xs text-center p-6 transform scale-95 opacity-0">
            <h3 class="font-bold text-lg mb-2">Yêu cầu đăng nhập</h3>
            <p class="text-sm text-gray-600 mb-6">Bạn cần đăng nhập để tạo hoặc tham gia phòng.</p>
            <button id="modalLoginButton" class="w-full bg-white px-4 py-2 rounded-full shadow-md font-semibold text-gray-700 flex items-center justify-center gap-3 hover:bg-gray-200 border">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.902,35.61,44,29.593,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Đăng nhập với Google
            </button>
        </div>
    </div>
    
    <div id="bottomSheetContainer" class="modal-hidden fixed inset-0 z-[2000]"><div id="sheetBackdrop" class="backdrop absolute inset-0 bg-black bg-opacity-50"></div><div id="memberSheet" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-xl max-h-[70vh] flex flex-col transform translate-y-full"><div class="p-4 border-b flex-shrink-0"><h2 class="text-xl font-bold text-teal-600 text-center">Danh sách thành viên</h2></div><ul id="memberList" class="overflow-y-auto p-2"></ul></div></div>
    
    <script type="module">
        // --- PHẦN -1: TÍCH HỢP FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDn-3B1ZNCq9E9XuNoHHHiyIo_Pegy8Ogk",
            authDomain: "ailocal-7501e.firebaseapp.com",
            databaseURL: "https://ailocal-7501e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ailocal-7501e",
            storageBucket: "ailocal-7501e.appspot.com",
            messagingSenderId: "21856417488",
            appId: "1:21856417488:web:c3542543f12cab547b90d5"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- PHẦN 0: CÀI ĐẶT CHUNG & BIẾN TOÀN CỤC ---
        const setAppHeight = () => document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        window.addEventListener('resize', setAppHeight);
        setAppHeight();
        
        let currentUser = null, currentRoomId = null, currentRoomAdminId = null;
        let map, markers, isLive = false, watchId = null;
        let myLocation = null, wakeLock = null, allLiveUsers = {};
        
        // --- PHẦN 1: THAM CHIẾU HTML ---
        const welcomeScreen = document.getElementById('welcomeScreen');
        const createRoomButton = document.getElementById('createRoomButton');
        const mapScreen = document.getElementById('mapScreen');
        const loginModal = document.getElementById('loginModal');
        const modalLoginButton = document.getElementById('modalLoginButton');
        // Các tham chiếu cho màn hình bản đồ
        let userPhoto, userName, logoutButton, goLiveButton, statusSelector, memberListButton, inviteButton;
        let recenterButton, fitToAllButton, wakeLockButton;
        let bottomSheetContainer, sheetBackdrop, memberSheet, memberList;


        // --- PHẦN 2: LUỒNG ĐIỀU KHIỂN CHÍNH (URL & AUTH) ---
        
        function main() {
            const params = new URLSearchParams(window.location.search);
            currentRoomId = params.get('room');

            onAuthStateChanged(auth, user => {
                currentUser = user;
                if (currentRoomId) {
                    if (currentUser) {
                        loginModal.classList.add('modal-hidden');
                        joinRoom(currentRoomId);
                    } else {
                        showLoginModal();
                    }
                } else {
                    welcomeScreen.style.display = 'flex';
                    mapScreen.style.display = 'none';
                }
            });
        }
        main();

        function showLoginModal() {
            loginModal.classList.remove('modal-hidden');
            requestAnimationFrame(() => {
                loginModal.querySelector('.backdrop').classList.add('opacity-100');
                loginModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
            });
        }

        async function createNewRoom() {
            if (!currentUser) {
                showLoginModal();
                return;
            }
            const roomId = Math.random().toString(36).substring(2, 9);
            const newRoomRef = ref(db, `rooms/${roomId}`);
            await set(newRoomRef, {
                adminId: currentUser.uid,
                createdAt: serverTimestamp(),
                name: `${currentUser.displayName}'s Room`
            });
            window.location.href = `?room=${roomId}`;
        }
        
        async function joinRoom(roomId) {
            const roomRef = ref(db, `rooms/${roomId}`);
            const snapshot = await get(roomRef);
            if (!snapshot.exists()) {
                alert("Phòng không tồn tại!");
                window.location.href = window.location.pathname;
                return;
            }
            
            currentRoomAdminId = snapshot.val().adminId;
            welcomeScreen.style.display = 'none';
            mapScreen.style.display = 'flex';
            
            initializeMapScreenElements();
            setupEventListeners();
            
            userPhoto.src = currentUser.photoURL;
            userName.textContent = currentUser.displayName;

            if (!map) initMap();
            listenToLiveLocations(roomId);
        }

        // --- PHẦN 3: KHỞI TẠO GIAO DIỆN BẢN ĐỒ ---
        function initializeMapScreenElements() {
            userPhoto = document.getElementById('userPhoto');
            userName = document.getElementById('userName');
            logoutButton = document.getElementById('logoutButton');
            goLiveButton = document.getElementById('goLiveButton');
            statusSelector = document.getElementById('statusSelector');
            memberListButton = document.getElementById('memberListButton');
            inviteButton = document.getElementById('inviteButton');
            recenterButton = document.getElementById('recenterButton');
            fitToAllButton = document.getElementById('fitToAllButton');
            wakeLockButton = document.getElementById('wakeLockButton');
            bottomSheetContainer = document.getElementById('bottomSheetContainer');
            sheetBackdrop = document.getElementById('sheetBackdrop');
            memberSheet = document.getElementById('memberSheet');
            memberList = document.getElementById('memberList');
        }
        
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([21.0285, 105.8542], 13);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>', maxZoom: 20
            }).addTo(map);
            markers = L.markerClusterGroup();
            map.addLayer(markers);
        }
        
        // --- PHẦN 4: LOGIC CHIA SẺ VỊ TRÍ (TRONG PHÒNG) ---
        function listenToLiveLocations(roomId) {
            const eventRef = ref(db, `rooms/${roomId}/live_locations`);
            onValue(eventRef, (snapshot) => {
                if (!map) return;
                allLiveUsers = snapshot.val() || {};
                markers.clearLayers();
                let newMarkersList = [];
                Object.keys(allLiveUsers).forEach(userId => {
                    const userData = allLiveUsers[userId];
                    const userLatLng = [userData.lat, userData.lng];
                    const icon = createStatusIcon(userData.photo, userData.status);
                    const newMarker = L.marker(userLatLng, { icon });
                    newMarker.on('click', () => map.flyTo(userLatLng, 18));
                    newMarkersList.push(newMarker);
                });
                markers.addLayers(newMarkersList);
                updateMemberList();
            });
        }
        
        function updateMyLocation(position) {
            if (!currentUser || !currentRoomId) return;
            const { latitude, longitude } = position.coords;
            myLocation = [latitude, longitude];
            const myLocationRef = ref(db, `rooms/${currentRoomId}/live_locations/${currentUser.uid}`);
            const currentStatus = statusSelector.value || null; // Gửi null nếu chưa chọn
            set(myLocationRef, {
                lat: latitude, lng: longitude, name: currentUser.displayName,
                photo: currentUser.photoURL, status: currentStatus,
                timestamp: serverTimestamp()
            });
            onDisconnect(myLocationRef).remove();
        }

        function createStatusIcon(photoUrl, status) {
            const effectiveStatus = status || 'Đang di chuyển';
            let borderColorClass = 'border-blue-500'; // Mặc định
            if (effectiveStatus === 'Dừng nghỉ') borderColorClass = 'border-yellow-400';
            if (effectiveStatus === 'Đến nơi') borderColorClass = 'border-green-500';
            if (effectiveStatus === 'Gặp sự cố') borderColorClass = 'border-red-600';
            return L.divIcon({
                html: `<img src="${photoUrl}" class="w-full h-full rounded-full border-4 ${borderColorClass}">`,
                className: 'custom-marker-icon', iconSize: [40, 40],
                iconAnchor: [20, 40], popupAnchor: [0, -40]
            });
        }

        function handleGoLive() {
             isLive = !isLive;
            if (isLive) {
                goLiveButton.textContent = "Dừng chia sẻ";
                statusSelector.classList.remove('hidden');
                const geoOptions = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                watchId = navigator.geolocation.watchPosition(updateMyLocation, (err) => alert(`Lỗi vị trí: ${err.message}`), geoOptions);
            } else {
                goLiveButton.textContent = "Bắt đầu chia sẻ vị trí";
                statusSelector.classList.add('hidden');
                if (watchId) navigator.geolocation.clearWatch(watchId);
                const myLocationRef = ref(db, `rooms/${currentRoomId}/live_locations/${currentUser.uid}`);
                set(myLocationRef, null);
                myLocation = null;
            }
        }

        function updateMemberList() {
            memberList.innerHTML = '';
            const users = Object.entries(allLiveUsers);
            if (users.length === 0) {
                memberList.innerHTML = '<li class="p-4 text-center text-gray-500">Không có ai đang hoạt động.</li>';
                return;
            }
            users.forEach(([userId, userData]) => {
                const li = document.createElement('li');
                li.className = 'flex items-center gap-3 p-3 border-b';
                const statusText = userData.status || 'Bình thường';
                const icon = createStatusIcon(userData.photo, userData.status);
                li.innerHTML = `
                    <div class="flex-grow flex items-center gap-3 cursor-pointer" data-user-id="${userId}">
                        <div class="w-10 h-10">${icon.options.html}</div>
                        <div>
                            <div class="font-semibold text-slate-800">${userData.name}</div>
                            <div class="text-sm text-gray-600">${statusText}</div>
                        </div>
                    </div>
                `;
                memberList.appendChild(li);
            });
        }

        function handleMemberClick(userId) {
             const user = allLiveUsers[userId];
             if (user && map) {
                 map.flyTo([user.lat, user.lng], 18);
                 closeSheet();
             }
        }
        
        function openSheet() {
            bottomSheetContainer.classList.remove('modal-hidden');
            requestAnimationFrame(() => {
                sheetBackdrop.classList.add('opacity-100');
                memberSheet.classList.remove('translate-y-full');
            });
        }

        function closeSheet() {
            sheetBackdrop.classList.remove('opacity-100');
            memberSheet.classList.add('translate-y-full');
            setTimeout(() => bottomSheetContainer.classList.add('modal-hidden'), 300);
        }

        // --- PHẦN 5: GẮN SỰ KIỆN ---
        function setupEventListeners() {
            logoutButton.addEventListener('click', () => {
                if (isLive) {
                    const myLocationRef = ref(db, `rooms/${currentRoomId}/live_locations/${currentUser.uid}`);
                    set(myLocationRef, null);
                }
                signOut(auth).then(() => {
                    window.location.href = window.location.pathname;
                });
            });

            goLiveButton.addEventListener('click', handleGoLive);
            memberListButton.addEventListener('click', openSheet);
            sheetBackdrop.addEventListener('click', closeSheet);
            
            memberList.addEventListener('click', (e) => {
                const listItem = e.target.closest('div[data-user-id]');
                if (listItem) handleMemberClick(listItem.dataset.userId);
            });
            
            inviteButton.addEventListener('click', () => {
                navigator.clipboard.writeText(window.location.href);
                alert('Đã sao chép link mời!');
            });
            
            statusSelector.addEventListener('change', () => {
                if (isLive && myLocation) updateMyLocation({ coords: { latitude: myLocation[0], longitude: myLocation[1] } });
            });
        }
        
        createRoomButton.addEventListener('click', createNewRoom);
        modalLoginButton.addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider()).then(() => {
                // Sau khi đăng nhập thành công từ modal, tải lại trang
                // để luồng chính xử lý việc tham gia phòng
                window.location.reload();
            });
        });
    </script>
</body>
</html>
